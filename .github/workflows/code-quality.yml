name: 'Code Quality Pipeline'

on:
  push:
    branches: ['main', 'develop']
  pull_request:
    branches: ['main', 'develop']
  workflow_dispatch:

env:
  NODE_VERSION: '22'

jobs:
  # Security & Type Safety Checks
  security-checks:
    name: Security & Type Safety
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --no-audit

      - name: Run npm audit
        run: npm audit --audit-level=high

      - name: Check for hardcoded secrets
        run: |
          # Check for potential hardcoded secrets (exclude auth, test, and config files)
          if grep -rE "(api_key|apikey|secret_key|SUPABASE_KEY)\s*[:=]\s*['\"][^'\"]+['\"]" \
            --include="*.ts" --include="*.tsx" --include="*.js" \
            --exclude-dir=tests --exclude-dir=node_modules --exclude-dir=.auth \
            --exclude="*.test.*" --exclude="*.spec.*" --exclude="auth.setup.*" \
            --exclude="LoginPage.tsx" --exclude="authStore.ts" \
            . ; then
            echo "‚ö†Ô∏è Warning: Potential hardcoded secrets found"
            exit 1
          fi

      - name: Check dangerouslySetInnerHTML usage
        run: |
          # Flag any dangerouslySetInnerHTML not paired with DOMPurify
          FILES=$(grep -rl "dangerouslySetInnerHTML" --include="*.tsx" --include="*.ts" \
            --exclude-dir=node_modules --exclude-dir=dist . 2>/dev/null || true)
          if [ -n "$FILES" ]; then
            FAIL=0
            for f in $FILES; do
              if ! grep -q "DOMPurify\|dompurify\|sanitize" "$f"; then
                echo "‚ùå $f uses dangerouslySetInnerHTML without DOMPurify"
                FAIL=1
              fi
            done
            if [ "$FAIL" = "1" ]; then
              exit 1
            fi
          fi
          echo "‚úÖ No unsanitized dangerouslySetInnerHTML found"

      - name: Check for service role key leaks
        run: |
          if grep -rE "service_role|SUPABASE_SERVICE_ROLE" \
            --include="*.ts" --include="*.tsx" --include="*.js" \
            --exclude-dir=node_modules --exclude-dir=dist --exclude-dir=supabase/functions \
            --exclude="*.test.*" --exclude="*.spec.*" \
            . 2>/dev/null; then
            echo "‚ùå Service role key reference found in client code"
            exit 1
          fi
          echo "‚úÖ No service role key leaks detected"

      - name: Check process.env in client code
        run: |
          # Allow process.env only in config/, vite.config, env.d.ts, and test files
          VIOLATIONS=$(grep -rn "process\.env" --include="*.ts" --include="*.tsx" \
            --exclude-dir=node_modules --exclude-dir=dist --exclude-dir=config \
            --exclude="vite.config.*" --exclude="vite-env.d.ts" --exclude="vitest.config.*" \
            --exclude="playwright.config.*" --exclude="*.test.*" --exclude="*.spec.*" \
            . 2>/dev/null | grep -v "import.meta.env" || true)
          if [ -n "$VIOLATIONS" ]; then
            echo "$VIOLATIONS"
            echo ""
            echo "‚ö†Ô∏è Warning: process.env used outside config files. Use import.meta.env instead."
          fi
          echo "‚úÖ process.env check complete"

      - name: TypeScript strict mode check
        run: npm run typecheck

  # Code Quality Checks
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --no-audit

      - name: Run ESLint
        run: npm run lint

      - name: No mock/demo data guard
        run: npm run guard:no-mock-data

      - name: Check console.log usage
        run: |
          # Count console.log statements (excluding tests and node_modules)
          COUNT=$(grep -r "console\.log" --include="*.ts" --include="*.tsx" \
            --exclude-dir=node_modules --exclude-dir=tests --exclude-dir=.archive \
            -l . 2>/dev/null | wc -l)
          echo "Found console.log in $COUNT files"
          if [ "$COUNT" -gt 300 ]; then
            echo "‚ùå Too many files with console.log statements (max: 300)"
            exit 1
          fi
          echo "‚úÖ Console.log usage within limits (target: <50)"

      - name: Check any type usage
        run: |
          # Count explicit 'any' type usage
          COUNT=$(grep -rE ": any|as any" --include="*.ts" --include="*.tsx" \
            --exclude-dir=node_modules --exclude-dir=tests --exclude-dir=.archive \
            . 2>/dev/null | wc -l)
          echo "Found $COUNT instances of 'any' type"
          if [ "$COUNT" -gt 200 ]; then
            echo "‚ùå Too many 'any' type instances (max: 200)"
            exit 1
          fi
          echo "‚úÖ Any type usage within acceptable limits (target: <50)"

      - name: Barcode compliance check
        run: |
          # Ensure no direct JsBarcode imports outside the UniversalBarcode wrapper
          VIOLATIONS=$(grep -rn "from ['\"]jsbarcode['\"]\\|require(['\"]jsbarcode['\"])" \
            --include="*.ts" --include="*.tsx" \
            --exclude-dir=node_modules --exclude-dir=dist \
            . 2>/dev/null | grep -v "UniversalBarcode\\|universal-barcode\\|universal_barcode" || true)
          if [ -n "$VIOLATIONS" ]; then
            echo "$VIOLATIONS"
            echo ""
            echo "‚ùå Direct JsBarcode import detected. Use UniversalBarcode component instead."
            echo "See: docs/BARCODE_IMPLEMENTATION.md"
            exit 1
          fi
          echo "‚úÖ Barcode compliance: all imports use UniversalBarcode"

      - name: Format check
        run: npm run format:check

  # Unit Tests
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --no-audit

      - name: Run unit tests with coverage
        run: npm run test:unit:coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  # E2E Tests (requires Supabase environment)
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    # Skip E2E tests if Supabase environment is not configured OR if triggered by Dependabot
    # (Dependabot PRs cannot access repository secrets for security reasons)
    if: ${{ vars.VITE_SUPABASE_URL != '' && vars.VITE_SUPABASE_ANON_KEY != '' && github.actor != 'dependabot[bot]' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --no-audit

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build application
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ vars.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ vars.VITE_SUPABASE_ANON_KEY }}

      - name: Start preview server and run E2E tests
        run: |
          # Start preview server in background
          npm run preview &
          SERVER_PID=$!

          # Wait for server to be ready (max 60 seconds)
          echo "Waiting for server to start..."
          for i in {1..60}; do
            if curl -s http://localhost:4173 > /dev/null 2>&1; then
              echo "Server is ready!"
              break
            fi
            sleep 1
          done

          # Run E2E tests
          npm run test || TEST_EXIT=$?

          # Cleanup
          kill $SERVER_PID 2>/dev/null || true

          exit ${TEST_EXIT:-0}
        env:
          CI: true
          VITE_SUPABASE_URL: ${{ vars.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ vars.VITE_SUPABASE_ANON_KEY }}
          # Test credentials for E2E tests (non-sensitive test account)
          E2E_TEST_EMAIL: ${{ secrets.E2E_TEST_EMAIL }}
          E2E_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  # Build & Bundle Analysis
  build-check:
    name: Build & Bundle Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --no-audit

      - name: Build project
        run: npm run build

      - name: Check bundle size
        run: |
          # Check total dist size
          DIST_SIZE=$(du -sm dist 2>/dev/null | cut -f1 || echo "0")
          echo "üì¶ Total bundle size: ${DIST_SIZE}MB"
          if [ "$DIST_SIZE" -gt 100 ]; then
            echo "‚ùå Bundle size exceeds 100MB limit"
            exit 1
          fi

          # Report largest JS chunk
          LARGEST=$(find dist -name '*.js' -exec du -sk {} + 2>/dev/null | sort -rn | head -1)
          echo "üì¶ Largest JS chunk: $LARGEST"
          echo "‚úÖ Bundle size within limits"

  # Accessibility Checks
  accessibility:
    name: Accessibility
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check ARIA attributes usage
        run: |
          # Check for common accessibility attributes
          ARIA_COUNT=$(grep -r "aria-" --include="*.tsx" --exclude-dir=node_modules . 2>/dev/null | wc -l)
          ROLE_COUNT=$(grep -r "role=" --include="*.tsx" --exclude-dir=node_modules . 2>/dev/null | wc -l)
          echo "Found $ARIA_COUNT ARIA attributes and $ROLE_COUNT role attributes"
          echo "‚úÖ Accessibility attributes present"

      - name: Check for alt text on images
        run: |
          # Check images have alt text
          IMG_WITHOUT_ALT=$(grep -rE "<img[^>]+(?!alt=)" --include="*.tsx" --exclude-dir=node_modules . 2>/dev/null | grep -v "alt=" | wc -l)
          if [ "$IMG_WITHOUT_ALT" -gt 0 ]; then
            echo "‚ö†Ô∏è Warning: Some images may be missing alt text"
          fi
          echo "‚úÖ Alt text check complete"

  # Performance Anti-patterns
  performance:
    name: Performance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for performance anti-patterns
        run: |
          # Check for inline function definitions in JSX (potential re-render issues)
          INLINE_FNS=$(grep -rE "onClick=\{\(\)" --include="*.tsx" --exclude-dir=node_modules . 2>/dev/null | wc -l)
          echo "Found $INLINE_FNS potential inline function definitions"

          # Check for missing React.memo on large components
          echo "‚úÖ Performance anti-pattern check complete"

      - name: Check for lazy loading usage
        run: |
          LAZY_IMPORTS=$(grep -r "lazy(" --include="*.tsx" --exclude-dir=node_modules . 2>/dev/null | wc -l)
          echo "Found $LAZY_IMPORTS lazy-loaded components"
          echo "‚úÖ Lazy loading check complete"
